<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>序列化 - Big Data</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Big Data</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="序列化"><a class="header" href="#序列化">序列化</a></h1>
<ul>
<li><a href="#21-%E5%BA%8F%E5%88%97%E5%8C%96%E6%A6%82%E8%BF%B0">2.1 序列化概述</a></li>
<li><a href="#22-%E8%87%AA%E5%AE%9A%E4%B9%89-bean-%E5%AF%B9%E8%B1%A1%E5%AE%9E%E7%8E%B0%E5%BA%8F%E5%88%97%E5%8C%96%E6%8E%A5%E5%8F%A3writable">2.2 自定义 bean 对象实现序列化接口（Writable）</a></li>
<li><a href="#23-%E5%BA%8F%E5%88%97%E5%8C%96%E6%A1%88%E4%BE%8B%E5%AE%9E%E6%93%8D">2.3 序列化案例实操</a></li>
</ul>
<h2 id="21-序列化概述"><a class="header" href="#21-序列化概述">2.1 序列化概述</a></h2>
<p>1）<strong>什么是序列化</strong></p>
<p>​ <strong>序列化</strong>就是把内存中的对象，转换成字节序列（或其他数据传输协议）以便于存储到磁盘（持久化）和网络传输。</p>
<p>​ <strong>反序列化</strong>就是将收到字节序列（或其他数据传输协议）或者是磁盘的持久化数据，转换成内存中的对象。</p>
<p>2）<strong>为什么要序列化</strong></p>
<p>​ 一般来说，“活的” 对象只生存在内存里，关机断电就没有了。而且 “活的” 对象只能由本地的进程使用，不能被发送到网络上的另外一台计算机。 然而序列化可以存储 “活的” 对象，可以将 “活的” 对象发送到远程计算机。</p>
<p>3）为什么不用 Java 的序列化</p>
<p>​ Java 的序列化是一个重量级序列化框架（Serializable），一个对象被序列化后，会附带很多额外的信息（各种校验信息，Header，继承体系等），不便于在网络中高效传输。所以，Hadoop 自己开发了一套序列化机制（Writable）。</p>
<p>4）Hadoop 序列化特点：</p>
<p><strong>（1</strong>）<strong>紧凑</strong>：高效使用存储空间。</p>
<p><strong>（2</strong>）快速：读写数据的额外开销小。</p>
<p><strong>（3</strong>）互操作：支持多语言的交互</p>
<h2 id="22-自定义-bean-对象实现序列化接口writable"><a class="header" href="#22-自定义-bean-对象实现序列化接口writable">2.2 自定义 bean 对象实现序列化接口（Writable）</a></h2>
<p>在企业开发中往往常用的基本序列化类型不能满足所有需求，比如在 Hadoop 框架内部传递一个 bean 对象，那么该对象就需要实现序列化接口。</p>
<p>具体实现 bean 对象序列化步骤如下 7 步。</p>
<p>（1）必须实现 Writable 接口</p>
<p>（2）反序列化时，需要反射调用空参构造函数，所以必须有空参构造</p>
<pre><code class="language-java">public FlowBean () {
	super ();
}
</code></pre>
<p>（3）重写序列化方法</p>
<pre><code class="language-java">@Override
public void write (DataOutput out) throws IOException {
	out.writeLong (upFlow);
	out.writeLong (downFlow);
	out.writeLong (sumFlow);
}
</code></pre>
<p>（4）重写反序列化方法</p>
<pre><code class="language-java">@Override
public void readFields (DataInput in) throws IOException {
	upFlow = in.readLong ();
	downFlow = in.readLong ();
	sumFlow = in.readLong ();
}

</code></pre>
<p>（5）<strong>注意</strong>反序列化的顺序和序列化的顺序完全一致</p>
<p>（6）要想把结果显示在文件中，需要重写 toString ()，可用”<code>\t</code>” 分开，方便后续用。</p>
<p>（7）如果需要将自定义的 bean 放在 key 中传输，则还需要实现 Comparable 接口，因为 MapReduce 框中的 Shuffle 过程要求对 key 必须能排序。详见后面排序案例。</p>
<pre><code class="language-java">@Override
public int compareTo (FlowBean o) {
	// 倒序排列，从大到小
	return this.sumFlow &gt; o.getSumFlow () ? -1 : 1;
}
</code></pre>
<h2 id="23-序列化案例实操"><a class="header" href="#23-序列化案例实操">2.3 序列化案例实操</a></h2>
<p><strong>1</strong>）需求</p>
<p>统计每一个手机号耗费的总上行流量、总下行流量、总流量</p>
<p>（1）输入数据</p>
<pre><code>vim phone_data.txt
</code></pre>
<p>相应数据为：</p>
<pre><code>1	13736230513	192.196.100.1	www.atguigu.com	2481	24681	200
2	13846544121	192.196.100.2			264	0	200
3 	13956435636	192.196.100.3			132	1512	200
4 	13966251146	192.168.100.1			240	0	404
5 	18271575951	192.168.100.2	www.atguigu.com	1527	2106	200
6 	84188413	192.168.100.3	www.atguigu.com	4116	1432	200
7 	13590439668	192.168.100.4			1116	954	200
8 	15910133277	192.168.100.5	www.hao123.com	3156	2936	200
9 	13729199489	192.168.100.6			240	0	200
10 	13630577991	192.168.100.7	www.shouhu.com	6960	690	200
11 	15043685818	192.168.100.8	www.baidu.com	3659	3538	200
12 	15959002129	192.168.100.9	www.atguigu.com	1938	180	500
13 	13560439638	192.168.100.10			918	4938	200
14 	13470253144	192.168.100.11			180	180	200
15 	13682846555	192.168.100.12	www.qq.com	1938	2910	200
16 	13992314666	192.168.100.13	www.gaga.com	3008	3720	200
17 	13509468723	192.168.100.14	www.qinghua.com	7335	110349	404
18 	18390173782	192.168.100.15	www.sogou.com	9531	2412	200
19 	13975057813	192.168.100.16	www.baidu.com	11058	48243	200
20 	13768778790	192.168.100.17			120	120	200
21 	13568436656	192.168.100.18	www.alibaba.com	2481	24681	200
22 	13568436656	192.168.100.19			1116	954	200
</code></pre>
<p>（2）输入数据格式：</p>
<pre><code>7    13560436666   120.196.100.99      1116       954           200 
id   手机号码      网络 ip             上行流量  下行流量   网络状态码  
</code></pre>
<p>（3）期望输出数据格式</p>
<pre><code>13560436666         1116         954               2070  
手机号码        上行流量     下行流量          总流量  
</code></pre>
<p><strong>2</strong>）需求分析</p>
<p><img src="https://cdn.jsdelivr.net/gh/Rosefinch-Midsummer/MyImagesHost04/img/20241105160111.png" alt="" /></p>
<p><strong>3</strong>）编写 MapReduce 程序</p>
<p>（1）编写流量统计的 Bean 对象</p>
<pre><code class="language-java">package com.TianHan.mapreduce.writable;

import org.apache.hadoop.io.Writable;
import java.io.DataInput;
import java.io.DataOutput;
import java.io.IOException;

//1 继承 Writable 接口
public class FlowBean implements Writable {

    private long upFlow; // 上行流量
    private long downFlow; // 下行流量
    private long sumFlow; // 总流量

    //2 提供无参构造
    public FlowBean () {
    }

    //3 提供三个参数的 getter 和 setter 方法
    public long getUpFlow () {
        return upFlow;
    }

    public void setUpFlow (long upFlow) {
        this.upFlow = upFlow;
    }

    public long getDownFlow () {
        return downFlow;
    }

    public void setDownFlow (long downFlow) {
        this.downFlow = downFlow;
    }

    public long getSumFlow () {
        return sumFlow;
    }

    public void setSumFlow (long sumFlow) {
        this.sumFlow = sumFlow;
    }

    public void setSumFlow () {
        this.sumFlow = this.upFlow + this.downFlow;
    }

    //4 实现序列化和反序列化方法，注意顺序一定要保持一致
    @Override
    public void write (DataOutput dataOutput) throws IOException {
        dataOutput.writeLong (upFlow);
        dataOutput.writeLong (downFlow);
        dataOutput.writeLong (sumFlow);
    }

    @Override
    public void readFields (DataInput dataInput) throws IOException {
        this.upFlow = dataInput.readLong ();
        this.downFlow = dataInput.readLong ();
        this.sumFlow = dataInput.readLong ();
    }

    //5 重写 ToString
    @Override
    public String toString () {
        return upFlow + "\t" + downFlow + "\t" + sumFlow;
    }
}

</code></pre>
<p>（2）编写 Mapper 类</p>
<pre><code class="language-java">package com.TianHan.mapreduce.writable;

import org.apache.hadoop.io.LongWritable;
import org.apache.hadoop.io.Text;
import org.apache.hadoop.mapreduce.Mapper;
import java.io.IOException;

public class FlowMapper extends Mapper&lt;LongWritable, Text, Text, FlowBean&gt; {
    private Text outK = new Text ();
    private FlowBean outV = new FlowBean ();

    @Override
    protected void map (LongWritable key, Text value, Context context) throws IOException, InterruptedException {

        //1 获取一行数据，转成字符串
        String line = value.toString ();

        //2 切割数据
        String [] split = line.split ("\t");

        //3 抓取我们需要的数据：手机号，上行流量，下行流量
        String phone = split [1];
        String up = split [split.length - 3];
        String down = split [split.length - 2];

        //4 封装 outK outV
        outK.set (phone);
        outV.setUpFlow (Long.parseLong (up));
        outV.setDownFlow (Long.parseLong (down));
        outV.setSumFlow ();

        //5 写出 outK outV
        context.write (outK, outV);
    }
}

</code></pre>
<p>（3）编写 Reducer 类</p>
<pre><code class="language-java">package com.TianHan.mapreduce.writable;

import org.apache.hadoop.io.Text;
import org.apache.hadoop.mapreduce.Reducer;
import java.io.IOException;

public class FlowReducer extends Reducer&lt;Text, FlowBean, Text, FlowBean&gt; {
    private FlowBean outV = new FlowBean ();
    @Override
    protected void reduce (Text key, Iterable&lt;FlowBean&gt; values, Context context) throws IOException, InterruptedException {

        long totalUp = 0;
        long totalDown = 0;

        //1 遍历 values, 将其中的上行流量，下行流量分别累加
        for (FlowBean flowBean : values) {
            totalUp += flowBean.getUpFlow ();
            totalDown += flowBean.getDownFlow ();
        }

        //2 封装 outKV
        outV.setUpFlow (totalUp);
        outV.setDownFlow (totalDown);
        outV.setSumFlow ();

        //3 写出 outK outV
        context.write (key,outV);
    }
}
</code></pre>
<p>（4）编写 Driver 驱动类</p>
<pre><code class="language-java">package com.TianHan.mapreduce.writable;

import org.apache.hadoop.conf.Configuration;
import org.apache.hadoop.fs.Path;
import org.apache.hadoop.io.Text;
import org.apache.hadoop.mapreduce.Job;
import org.apache.hadoop.mapreduce.lib.input.FileInputFormat;
import org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;
import java.io.IOException;

public class FlowDriver {
    public static void main (String [] args) throws IOException, ClassNotFoundException, InterruptedException {

        //1 获取 job 对象
        Configuration conf = new Configuration ();
        Job job = Job.getInstance (conf);

        //2 关联本 Driver 类
        job.setJarByClass (FlowDriver.class);

        //3 关联 Mapper 和 Reducer
        job.setMapperClass (FlowMapper.class);
        job.setReducerClass (FlowReducer.class);
        
		//4 设置 Map 端输出 KV 类型
        job.setMapOutputKeyClass (Text.class);
        job.setMapOutputValueClass (FlowBean.class);
        
		//5 设置程序最终输出的 KV 类型
        job.setOutputKeyClass (Text.class);
        job.setOutputValueClass (FlowBean.class);
        
		//6 设置程序的输入输出路径
        FileInputFormat.setInputPaths (job, new Path ("D:\\inputflow"));
        FileOutputFormat.setOutputPath (job, new Path ("D:\\flowoutput"));
        
		//7 提交 Job
        boolean b = job.waitForCompletion (true);
        System.exit (b ? 0 : 1);
    }
}
</code></pre>
<p>4）输出结果</p>
<pre><code>13470253144	180	180	360
13509468723	7335	110349	117684
13560439638	918	4938	5856
13568436656	3597	25635	29232
13590439668	1116	954	2070
13630577991	6960	690	7650
13682846555	1938	2910	4848
13729199489	240	0	240
13736230513	2481	24681	27162
13768778790	120	120	240
13846544121	264	0	264
13956435636	132	1512	1644
13966251146	240	0	240
13975057813	11058	48243	59301
13992314666	3008	3720	6728
15043685818	3659	3538	7197
15910133277	3156	2936	6092
15959002129	1938	180	2118
18271575951	1527	2106	3633
18390173782	9531	2412	11943
84188413	4116	1432	5548
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../Hadoop/MapReduce概述.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../Hadoop/MapReduce框架原理.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../Hadoop/MapReduce概述.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../Hadoop/MapReduce框架原理.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
